# {{ ansible_managed }} [ansible-playbooks v{{ ansibleplaybooks_version }}]
#
# Include this in your server {} block
#
# Example configuration (drop in /etc/conf/
# 8<------------------
#
# server {
#	listen 443;
#	listen [::]:443;
#	server_name trident.example.net;
#	access_log /var/log/nginx/trident-access.log
#
#	ssl_certificate ...
#	...
#
#	include /etc/trident/nginx/trident-server.inc
# }
# ------------------>8

	# Our webroot (contains static, non-sensitive files, source if public ;)
	root /usr/share/trident/webroot/;

	error_log syslog:server={{ rsyslog_server }},facility={{ syslog_facility }},tag=nginx,severity={{ syslog_severity }};
	access_log syslog:server={{ rsyslog_server }},facility={{ syslog_facility }},tag=nginx,severity={{ syslog_severity }};

	######################################################
	# Static files
	######################################################
{% if trident.version in [ '1.3.8' ] %}
	# Trident 1.3.8
	location /css/ {
	}

	location /favicon.ico {
	}

	location /gfx/ {
	}

	location /js/ {
	}
{% endif %}
{% if trident.version in [ '1.4.2', '1.4.5' ] %}
	# Trident 1.4.2
	location ~ ^/(css|gfx|js)/ {
		expires 7d;
		root /usr/share/;
		try_files /trident/webroot$uri /pitchfork/webroot$uri =404;
	}
{% endif %}

{% if trident.version in [ '1.4.2', '1.4.5' ] %}
	# Trident 1.4.2
	location /favicon.ico {
		expires 31d;
		root /usr/share/;
		try_files /trident/webroot$uri /pitchfork/webroot$uri =404;
	}
{% endif %}

	######################################################
	# Forward all requests to the Trident Daemon
	######################################################
{% if trident.version in [ '1.3.8' ] %}
	# Trident 1.3.8
	location / {
		client_max_body_size    0;
		proxy_set_header	Host $host;
		proxy_http_version	1.1;
		proxy_pass		http://trident-daemon;
	}
{% endif %}
{% if trident.version in [ '1.4.2', '1.4.5' ] %}
	# Trident 1.4.2
	location / {
		client_max_body_size    0;
		proxy_set_header  Host $host;
		proxy_http_version  1.1;
		proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;

		# No Connection header so that Keep-alive is performed where possible
		proxy_set_header	Connection "";

		# Pass it to Trident
		proxy_pass		http://trident-daemon;
	}
{% endif %}

